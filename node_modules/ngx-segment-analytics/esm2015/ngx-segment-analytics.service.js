import { Inject, Injectable } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { DEFAULT_CONFIG, SEGMENT_CONFIG } from './ngx-segment-analytics.config';
import { WindowWrapper } from './window-wrapper';
import * as i0 from "@angular/core";
import * as i1 from "./window-wrapper";
import * as i2 from "@angular/common";
import * as i3 from "./ngx-segment-analytics.config";
export class SegmentService {
    /**
     * @param _w Browser window
     * @param _doc Browser DOM
     * @param userConfig Segment configuration
     */
    constructor(_w, _doc, userConfig) {
        this._w = _w;
        this._doc = _doc;
        this._config = Object.assign(Object.assign({}, DEFAULT_CONFIG), userConfig);
        if (this._config.loadOnInitialization && (typeof this._config.apiKey === 'undefined' || this._config.apiKey === '')) {
            console.error('The API Key cannot be an empty string if Segment must be loaded on initialization.');
            return;
        }
        if (typeof this._w.analytics === 'undefined'
            || typeof this._w.analytics.initialize === 'undefined'
            || this._w.analytics.initialize === false) {
            if (typeof this._w.analytics !== 'undefined' && this._w.analytics.invoked === true) {
                console.error('Segment snippet included twice.');
                return;
            }
            if (this._config.debug) {
                console.log('Segment initialization...');
            }
            this._w.analytics = [];
            this._w.analytics.invoked = true;
            this._w.analytics.methods = [
                'trackSubmit',
                'trackClick',
                'trackLink',
                'trackForm',
                'pageview',
                'identify',
                'reset',
                'group',
                'track',
                'ready',
                'alias',
                'debug',
                'page',
                'once',
                'off',
                'on',
                'addSourceMiddleware',
                'addIntegrationMiddleware',
                'setAnonymousId',
                'addDestinationMiddleware',
            ];
            this._w.analytics.factory = (method) => {
                return (...args) => {
                    args.unshift(method);
                    this._w.analytics.push(args);
                    return this._w.analytics;
                };
            };
            this._w.analytics.methods.forEach((method) => {
                this._w.analytics[method] = this._w.analytics.factory(method);
            });
            this._w.analytics.load = (key, options) => {
                const script = this._doc.createElement('script');
                script.type = 'text/javascript';
                script.async = true;
                script.src = 'https://' + this._config.segmentHost + this._config.segmentUri.replace('$API_KEY$', key);
                const first = this._doc.getElementsByTagName('script')[0];
                first.parentNode.insertBefore(script, first);
                this._w.analytics._loadOptions = options;
            };
            this._w.analytics._writeKey = this._config.apiKey;
            this._w.analytics.SNIPPET_VERSION = '4.13.2';
            if (this._config.loadOnInitialization) {
                this.load(this._config.apiKey);
            }
        }
    }
    /**
     * Load Segment configuration.
     *
     * @param apiKey Write API Key
     * @param options Optional parameters
     */
    load(apiKey, options) {
        this._w.analytics.load(apiKey, options);
        if (this._config.debug) {
            console.log('Segment initialized');
        }
        this.debug(this._config.debug);
    }
    /**
     * The identify method is how you associate your users and their actions to a recognizable userId and traits.
     *
     * @param userId The database ID for the user.
     * @param traits A dictionary of traits you know about the user, like their email or name
     * @param options A dictionary of options.
     *
     * @returns
     */
    identify(userId, traits, options) {
        return new Promise((resolve) => {
            this._w.analytics.identify(userId, traits, options, _ => resolve(this));
        });
    }
    /**
     * The track method lets you record any actions your users perform.
     *
     * @param event The name of the event you’re tracking.
     * @param properties A dictionary of properties for the event.
     * @param options A dictionary of options.
     *
     * @returns
     */
    track(event, properties, options) {
        return new Promise((resolve) => {
            this._w.analytics.track(event, properties, options, _ => resolve(this));
        });
    }
    /**
     * The page method lets you record page views on your website, along with optional extra information about the page being viewed.
     *
     * @param category The category of the page.
     * @param name The name of the page.
     * @param properties A dictionary of properties of the page.
     * @param options A dictionary of options.
     *
     * @returns
     */
    page(category, name, properties, options) {
        return new Promise((resolve) => {
            this._w.analytics.page(category, name, properties, options, _ => resolve(this));
        });
    }
    /**
     * The group method associates an identified user with a company, organization, project, workspace, team, tribe, platoon,
     * assemblage, cluster, troop, gang, party, society or any other name you came up with for the same concept.
     *
     * @param groupId The Group ID to associate with the current user.
     * @param traits A dictionary of traits for the group.
     *
     * @returns
     */
    group(groupId, traits) {
        return new Promise((resolve) => {
            this._w.analytics.group(groupId, traits, _ => resolve(this));
        });
    }
    /**
     * The alias method combines two previously unassociated user identities.
     *
     * @param userId The new user ID you want to associate with the user.
     * @param previousId The previous ID that the user was recognized by. This defaults to the currently identified user’s ID.
     * @param options A dictionary of options.
     *
     * @returns
     */
    alias(userId, previousId, options) {
        return new Promise((resolve) => {
            this._w.analytics.alias(userId, previousId, options, _ => resolve(this));
        });
    }
    /**
     * The ready method allows you execute a promise that will be called as soon as all of your enabled destinations have loaded
     * and analytics.js has completed initialization.
     *
     * @returns
     */
    ready() {
        return new Promise((resolve) => {
            this._w.analytics.ready(_ => resolve(this));
        });
    }
    /**
     * Return informations about the currently identified user
     *
     * @returns Informations about the currently identified user
     */
    user() {
        return this._w.analytics.user();
    }
    /**
     * Return identifier about the currently identified user
     *
     * @returns Identifier about the currently identified user
     */
    id() {
        return this._w.analytics.id();
    }
    /**
     * Override the default Anonymous ID
     *
     * @param anonymousId New anonymous ID
     */
    setAnonymousId(anonymousId) {
        this._w.analytics.setAnonymousId(anonymousId);
    }
    /**
     * Return traits about the currently identified user
     *
     * @returns Traits about the currently identified user
     */
    traits() {
        return this._w.analytics.user().traits();
    }
    /**
     * Reset the id, including anonymousId, and clear traits for the currently identified user and group.
     */
    reset() {
        this._w.analytics.reset();
    }
    /**
     * Turn on/off debug mode, logging helpful messages to the console.
     *
     * @param enabled Enable or not the debug mode
     */
    debug(enabled) {
        this._w.analytics.debug(enabled);
    }
    /**
     * Set listeners for these events and run your own custom code.
     *
     * @param method Name of the method to listen for
     * @param callback A function to execute after each the emitted method
     */
    on(method, callback) {
        this._w.analytics.on(method, callback);
    }
    /**
     * Attaches the `track` call as a handler to a link
     *
     * @param elements DOM element or an array of DOM elements to be bound with track method.
     * @param event The name of the event, passed to the `track` method or a function that returns a string to be used
     *              as the name of the track event.
     * @param properties A dictionary of properties to pass with the `track` method.
     */
    trackLink(elements, event, properties) {
        this._w.analytics.trackLink(elements, event, properties);
    }
    /**
     * Binds a `track` call to a form submission.
     *
     * @param forms The form element to track or an array of form
     * @param event The name of the event, passed to the `track` method.
     * @param properties A dictionary of properties to pass with the `track` method.
     */
    trackForm(forms, event, properties) {
        this._w.analytics.trackForm(forms, event, properties);
    }
    /**
     * Set the length (in milliseconds) of the callbacks and helper functions
     *
     * @param timeout Number of milliseconds
     */
    timeout(timeout) {
        this._w.analytics.timeout(timeout);
    }
    /**
     * Add a source middleware called on events
     *
     * @param middleware Custom function
     */
    addSourceMiddleware(middleware) {
        this._w.analytics.addSourceMiddleware(middleware);
    }
    /**
     * Add a destination middleware called on events
     *
     * @param integration Integration name
     * @param middlewares Custom functions
     */
    addDestinationMiddleware(integration, middlewares) {
        this._w.analytics.addDestinationMiddleware(integration, middlewares);
    }
    get plugins() {
        return this._w.analytics.plugins;
    }
}
SegmentService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SegmentService_Factory() { return new SegmentService(i0.ɵɵinject(i1.WindowWrapper), i0.ɵɵinject(i2.DOCUMENT), i0.ɵɵinject(i3.SEGMENT_CONFIG)); }, token: SegmentService, providedIn: "root" });
SegmentService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
SegmentService.ctorParameters = () => [
    { type: WindowWrapper, decorators: [{ type: Inject, args: [WindowWrapper,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [SEGMENT_CONFIG,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LXNlZ21lbnQtYW5hbHl0aWNzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbmd4LXNlZ21lbnQtYW5hbHl0aWNzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDakQsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBQyxjQUFjLEVBQUUsY0FBYyxFQUFnQixNQUFNLGdDQUFnQyxDQUFDO0FBQzdGLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQzs7Ozs7QUFlL0MsTUFBTSxPQUFPLGNBQWM7SUFJdkI7Ozs7T0FJRztJQUNILFlBQ21DLEVBQWlCLEVBQ3RCLElBQVMsRUFDWCxVQUF5QjtRQUZsQixPQUFFLEdBQUYsRUFBRSxDQUFlO1FBQ3RCLFNBQUksR0FBSixJQUFJLENBQUs7UUFHbkMsSUFBSSxDQUFDLE9BQU8sbUNBQU8sY0FBYyxHQUFLLFVBQVUsQ0FBQyxDQUFDO1FBRWxELElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEtBQUssV0FBVyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxLQUFLLEVBQUUsQ0FBQyxFQUFFO1lBQ2pILE9BQU8sQ0FBQyxLQUFLLENBQUMsb0ZBQW9GLENBQUMsQ0FBQztZQUNwRyxPQUFPO1NBQ1Y7UUFFRCxJQUNJLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEtBQUssV0FBVztlQUNyQyxPQUFPLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLFVBQVUsS0FBSyxXQUFXO2VBQ25ELElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLFVBQVUsS0FBSyxLQUFLLEVBQzNDO1lBQ0UsSUFBSSxPQUFPLElB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QUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0ksU0FBUyxDQUFDLEtBQWtDLEVBQUUsS0FBd0IsRUFBRSxVQUEyQjtRQUN0RyxJQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLE9BQU8sQ0FBQyxPQUFlO1FBQzFCLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLG1CQUFtQixDQUFDLFVBQTZCO1FBQ3BELElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLHdCQUF3QixDQUFDLFdBQW1CLEVBQUUsV0FBZ0M7UUFDakYsSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsd0JBQXdCLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFFRCxJQUFXLE9BQU87UUFDZCxPQUFPLElBQUksQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQztJQUNyQyxDQUFDOzs7O1lBL1VKLFVBQVUsU0FBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNyQjs7O1lBZE8sYUFBYSx1QkF5QlosTUFBTSxTQUFDLGFBQWE7NENBQ3BCLE1BQU0sU0FBQyxRQUFROzRDQUNmLE1BQU0sU0FBQyxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3QsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtET0NVTUVOVH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7REVGQVVMVF9DT05GSUcsIFNFR01FTlRfQ09ORklHLCBTZWdtZW50Q29uZmlnfSBmcm9tICcuL25neC1zZWdtZW50LWFuYWx5dGljcy5jb25maWcnO1xuaW1wb3J0IHtXaW5kb3dXcmFwcGVyfSBmcm9tICcuL3dpbmRvdy13cmFwcGVyJztcblxuZXhwb3J0IGludGVyZmFjZSBTZWdtZW50UGx1Z2luIHtcbiAgICAvLyBWaWRlbyBQbHVnaW5zXG4gICAgbmV3KHBsYXllcjogYW55LCBhY2Nlc3NUb2tlbjogc3RyaW5nKTogYW55O1xuXG4gICAgLy8gT3RoZXJzIHBsdWdpbnNcbiAgICBuZXcoKTogYW55O1xufVxuXG5leHBvcnQgdHlwZSBTZWdtZW50TWlkZGxld2FyZSA9ICh7aW50ZWdyYXRpb25zLCBwYXlsb2FkLCBuZXh0fSkgPT4gdm9pZDtcblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgU2VnbWVudFNlcnZpY2Uge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBfY29uZmlnOiBTZWdtZW50Q29uZmlnO1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIF93IEJyb3dzZXIgd2luZG93XG4gICAgICogQHBhcmFtIF9kb2MgQnJvd3NlciBET01cbiAgICAgKiBAcGFyYW0gdXNlckNvbmZpZyBTZWdtZW50IGNvbmZpZ3VyYXRpb25cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgQEluamVjdChXaW5kb3dXcmFwcGVyKSBwcml2YXRlIF93OiBXaW5kb3dXcmFwcGVyLFxuICAgICAgICBASW5qZWN0KERPQ1VNRU5UKSBwcml2YXRlIF9kb2M6IGFueSxcbiAgICAgICAgQEluamVjdChTRUdNRU5UX0NPTkZJRykgdXNlckNvbmZpZzogU2VnbWVudENvbmZpZ1xuICAgICkge1xuICAgICAgICB0aGlzLl9jb25maWcgPSB7Li4uREVGQVVMVF9DT05GSUcsIC4uLnVzZXJDb25maWd9O1xuXG4gICAgICAgIGlmICh0aGlzLl9jb25maWcubG9hZE9uSW5pdGlhbGl6YXRpb24gJiYgKHR5cGVvZiB0aGlzLl9jb25maWcuYXBpS2V5ID09PSAndW5kZWZpbmVkJyB8fCB0aGlzLl9jb25maWcuYXBpS2V5ID09PSAnJykpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1RoZSBBUEkgS2V5IGNhbm5vdCBiZSBhbiBlbXB0eSBzdHJpbmcgaWYgU2VnbWVudCBtdXN0IGJlIGxvYWRlZCBvbiBpbml0aWFsaXphdGlvbi4nKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIHR5cGVvZiB0aGlzLl93LmFuYWx5dGljcyA9PT0gJ3VuZGVmaW5lZCdcbiAgICAgICAgICAgIHx8IHR5cGVvZiB0aGlzLl93LmFuYWx5dGljcy5pbml0aWFsaXplID09PSAndW5kZWZpbmVkJ1xuICAgICAgICAgICAgfHwgdGhpcy5fdy5hbmFseXRpY3MuaW5pdGlhbGl6ZSA9PT0gZmFsc2VcbiAgICAgICAgKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3cuYW5hbHl0aWNzICE9PSAndW5kZWZpbmVkJyAmJiB0aGlzLl93LmFuYWx5dGljcy5pbnZva2VkID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignU2VnbWVudCBzbmlwcGV0IGluY2x1ZGVkIHR3aWNlLicpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMuX2NvbmZpZy5kZWJ1Zykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTZWdtZW50IGluaXRpYWxpemF0aW9uLi4uJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuX3cuYW5hbHl0aWNzID0gW107XG4gICAgICAgICAgICB0aGlzLl93LmFuYWx5dGljcy5pbnZva2VkID0gdHJ1ZTtcblxuICAgICAgICAgICAgdGhpcy5fdy5hbmFseXRpY3MubWV0aG9kcyA9IFtcbiAgICAgICAgICAgICAgICAndHJhY2tTdWJtaXQnLFxuICAgICAgICAgICAgICAgICd0cmFja0NsaWNrJyxcbiAgICAgICAgICAgICAgICAndHJhY2tMaW5rJyxcbiAgICAgICAgICAgICAgICAndHJhY2tGb3JtJyxcbiAgICAgICAgICAgICAgICAncGFnZXZpZXcnLFxuICAgICAgICAgICAgICAgICdpZGVudGlmeScsXG4gICAgICAgICAgICAgICAgJ3Jlc2V0JyxcbiAgICAgICAgICAgICAgICAnZ3JvdXAnLFxuICAgICAgICAgICAgICAgICd0cmFjaycsXG4gICAgICAgICAgICAgICAgJ3JlYWR5JyxcbiAgICAgICAgICAgICAgICAnYWxpYXMnLFxuICAgICAgICAgICAgICAgICdkZWJ1ZycsXG4gICAgICAgICAgICAgICAgJ3BhZ2UnLFxuICAgICAgICAgICAgICAgICdvbmNlJyxcbiAgICAgICAgICAgICAgICAnb2ZmJyxcbiAgICAgICAgICAgICAgICAnb24nLFxuICAgICAgICAgICAgICAgICdhZGRTb3VyY2VNaWRkbGV3YXJlJyxcbiAgICAgICAgICAgICAgICAnYWRkSW50ZWdyYXRpb25NaWRkbGV3YXJlJyxcbiAgICAgICAgICAgICAgICAnc2V0QW5vbnltb3VzSWQnLFxuICAgICAgICAgICAgICAgICdhZGREZXN0aW5hdGlvbk1pZGRsZXdhcmUnLFxuICAgICAgICAgICAgXTtcblxuICAgICAgICAgICAgdGhpcy5fdy5hbmFseXRpY3MuZmFjdG9yeSA9IChtZXRob2Q6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAoLi4uYXJncykgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhcmdzLnVuc2hpZnQobWV0aG9kKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdy5hbmFseXRpY3MucHVzaChhcmdzKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3cuYW5hbHl0aWNzO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLl93LmFuYWx5dGljcy5tZXRob2RzLmZvckVhY2goKG1ldGhvZDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fdy5hbmFseXRpY3NbbWV0aG9kXSA9IHRoaXMuX3cuYW5hbHl0aWNzLmZhY3RvcnkobWV0aG9kKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB0aGlzLl93LmFuYWx5dGljcy5sb2FkID0gKGtleTogc3RyaW5nLCBvcHRpb25zOiB7IGludGVncmF0aW9uczogeyBba2V5OiBzdHJpbmddOiBib29sZWFuIH0gfSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNjcmlwdCA9IHRoaXMuX2RvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgICAgICAgICAgICBzY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnO1xuICAgICAgICAgICAgICAgIHNjcmlwdC5hc3luYyA9IHRydWU7XG4gICAgICAgICAgICAgICAgc2NyaXB0LnNyYyA9ICdodHRwczovLycgKyB0aGlzLl9jb25maWcuc2VnbWVudEhvc3QgKyB0aGlzLl9jb25maWcuc2VnbWVudFVyaS5yZXBsYWNlKCckQVBJX0tFWSQnLCBrZXkpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgZmlyc3QgPSB0aGlzLl9kb2MuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpWzBdO1xuICAgICAgICAgICAgICAgIGZpcnN0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNjcmlwdCwgZmlyc3QpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3cuYW5hbHl0aWNzLl9sb2FkT3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLl93LmFuYWx5dGljcy5fd3JpdGVLZXkgPSB0aGlzLl9jb25maWcuYXBpS2V5O1xuICAgICAgICAgICAgdGhpcy5fdy5hbmFseXRpY3MuU05JUFBFVF9WRVJTSU9OID0gJzQuMTMuMic7XG4gICAgICAgICAgICBpZiAodGhpcy5fY29uZmlnLmxvYWRPbkluaXRpYWxpemF0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5sb2FkKHRoaXMuX2NvbmZpZy5hcGlLZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogTG9hZCBTZWdtZW50IGNvbmZpZ3VyYXRpb24uXG4gICAgICpcbiAgICAgKiBAcGFyYW0gYXBpS2V5IFdyaXRlIEFQSSBLZXlcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBPcHRpb25hbCBwYXJhbWV0ZXJzXG4gICAgICovXG4gICAgcHVibGljIGxvYWQoYXBpS2V5OiBzdHJpbmcsIG9wdGlvbnM/OiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fdy5hbmFseXRpY3MubG9hZChhcGlLZXksIG9wdGlvbnMpO1xuICAgICAgICBpZiAodGhpcy5fY29uZmlnLmRlYnVnKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnU2VnbWVudCBpbml0aWFsaXplZCcpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGVidWcodGhpcy5fY29uZmlnLmRlYnVnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWRlbnRpZnkgbWV0aG9kIGlzIGhvdyB5b3UgYXNzb2NpYXRlIHlvdXIgdXNlcnMgYW5kIHRoZWlyIGFjdGlvbnMgdG8gYSByZWNvZ25pemFibGUgdXNlcklkIGFuZCB0cmFpdHMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gdXNlcklkIFRoZSBkYXRhYmFzZSBJRCBmb3IgdGhlIHVzZXIuXG4gICAgICogQHBhcmFtIHRyYWl0cyBBIGRpY3Rpb25hcnkgb2YgdHJhaXRzIHlvdSBrbm93IGFib3V0IHRoZSB1c2VyLCBsaWtlIHRoZWlyIGVtYWlsIG9yIG5hbWVcbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBBIGRpY3Rpb25hcnkgb2Ygb3B0aW9ucy5cbiAgICAgKlxuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgcHVibGljIGlkZW50aWZ5KHVzZXJJZD86IHN0cmluZywgdHJhaXRzPzogYW55LCBvcHRpb25zPzogYW55KTogUHJvbWlzZTxTZWdtZW50U2VydmljZT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3cuYW5hbHl0aWNzLmlkZW50aWZ5KHVzZXJJZCwgdHJhaXRzLCBvcHRpb25zLCBfID0+IHJlc29sdmUodGhpcykpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgdHJhY2sgbWV0aG9kIGxldHMgeW91IHJlY29yZCBhbnkgYWN0aW9ucyB5b3VyIHVzZXJzIHBlcmZvcm0uXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZXZlbnQgVGhlIG5hbWUgb2YgdGhlIGV2ZW50IHlvdeKAmXJlIHRyYWNraW5nLlxuICAgICAqIEBwYXJhbSBwcm9wZXJ0aWVzIEEgZGljdGlvbmFyeSBvZiBwcm9wZXJ0aWVzIGZvciB0aGUgZXZlbnQuXG4gICAgICogQHBhcmFtIG9wdGlvbnMgQSBkaWN0aW9uYXJ5IG9mIG9wdGlvbnMuXG4gICAgICpcbiAgICAgKiBAcmV0dXJuc1xuICAgICAqL1xuICAgIHB1YmxpYyB0cmFjayhldmVudDogc3RyaW5nLCBwcm9wZXJ0aWVzPzogYW55LCBvcHRpb25zPzogYW55KTogUHJvbWlzZTxTZWdtZW50U2VydmljZT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3cuYW5hbHl0aWNzLnRyYWNrKGV2ZW50LCBwcm9wZXJ0aWVzLCBvcHRpb25zLCBfID0+IHJlc29sdmUodGhpcykpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgcGFnZSBtZXRob2QgbGV0cyB5b3UgcmVjb3JkIHBhZ2Ugdmlld3Mgb24geW91ciB3ZWJzaXRlLCBhbG9uZyB3aXRoIG9wdGlvbmFsIGV4dHJhIGluZm9ybWF0aW9uIGFib3V0IHRoZSBwYWdlIGJlaW5nIHZpZXdlZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBwYWdlLlxuICAgICAqIEBwYXJhbSBwcm9wZXJ0aWVzIEEgZGljdGlvbmFyeSBvZiBwcm9wZXJ0aWVzIG9mIHRoZSBwYWdlLlxuICAgICAqIEBwYXJhbSBvcHRpb25zIEEgZGljdGlvbmFyeSBvZiBvcHRpb25zLlxuICAgICAqXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBwdWJsaWMgcGFnZShuYW1lPzogc3RyaW5nLCBwcm9wZXJ0aWVzPzogYW55LCBvcHRpb25zPzogYW55KTogUHJvbWlzZTxTZWdtZW50U2VydmljZT47XG5cbiAgICAvKipcbiAgICAgKiBUaGUgcGFnZSBtZXRob2QgbGV0cyB5b3UgcmVjb3JkIHBhZ2Ugdmlld3Mgb24geW91ciB3ZWJzaXRlLCBhbG9uZyB3aXRoIG9wdGlvbmFsIGV4dHJhIGluZm9ybWF0aW9uIGFib3V0IHRoZSBwYWdlIGJlaW5nIHZpZXdlZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBjYXRlZ29yeSBUaGUgY2F0ZWdvcnkgb2YgdGhlIHBhZ2UuXG4gICAgICogQHBhcmFtIG5hbWUgVGhlIG5hbWUgb2YgdGhlIHBhZ2UuXG4gICAgICogQHBhcmFtIHByb3BlcnRpZXMgQSBkaWN0aW9uYXJ5IG9mIHByb3BlcnRpZXMgb2YgdGhlIHBhZ2UuXG4gICAgICogQHBhcmFtIG9wdGlvbnMgQSBkaWN0aW9uYXJ5IG9mIG9wdGlvbnMuXG4gICAgICpcbiAgICAgKiBAcmV0dXJuc1xuICAgICAqL1xuICAgIHB1YmxpYyBwYWdlKGNhdGVnb3J5OiBzdHJpbmcsIG5hbWU6IHN0cmluZywgcHJvcGVydGllcz86IGFueSwgb3B0aW9ucz86IGFueSk6IFByb21pc2U8U2VnbWVudFNlcnZpY2U+O1xuXG4gICAgLyoqXG4gICAgICogVGhlIHBhZ2UgbWV0aG9kIGxldHMgeW91IHJlY29yZCBwYWdlIHZpZXdzIG9uIHlvdXIgd2Vic2l0ZSwgYWxvbmcgd2l0aCBvcHRpb25hbCBleHRyYSBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcGFnZSBiZWluZyB2aWV3ZWQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gY2F0ZWdvcnkgVGhlIGNhdGVnb3J5IG9mIHRoZSBwYWdlLlxuICAgICAqIEBwYXJhbSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBwYWdlLlxuICAgICAqIEBwYXJhbSBwcm9wZXJ0aWVzIEEgZGljdGlvbmFyeSBvZiBwcm9wZXJ0aWVzIG9mIHRoZSBwYWdlLlxuICAgICAqIEBwYXJhbSBvcHRpb25zIEEgZGljdGlvbmFyeSBvZiBvcHRpb25zLlxuICAgICAqXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBwdWJsaWMgcGFnZShjYXRlZ29yeT86IHN0cmluZywgbmFtZT86IHN0cmluZywgcHJvcGVydGllcz86IGFueSwgb3B0aW9ucz86IGFueSk6IFByb21pc2U8U2VnbWVudFNlcnZpY2U+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl93LmFuYWx5dGljcy5wYWdlKGNhdGVnb3J5LCBuYW1lLCBwcm9wZXJ0aWVzLCBvcHRpb25zLCBfID0+IHJlc29sdmUodGhpcykpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgZ3JvdXAgbWV0aG9kIGFzc29jaWF0ZXMgYW4gaWRlbnRpZmllZCB1c2VyIHdpdGggYSBjb21wYW55LCBvcmdhbml6YXRpb24sIHByb2plY3QsIHdvcmtzcGFjZSwgdGVhbSwgdHJpYmUsIHBsYXRvb24sXG4gICAgICogYXNzZW1ibGFnZSwgY2x1c3RlciwgdHJvb3AsIGdhbmcsIHBhcnR5LCBzb2NpZXR5IG9yIGFueSBvdGhlciBuYW1lIHlvdSBjYW1lIHVwIHdpdGggZm9yIHRoZSBzYW1lIGNvbmNlcHQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZ3JvdXBJZCBUaGUgR3JvdXAgSUQgdG8gYXNzb2NpYXRlIHdpdGggdGhlIGN1cnJlbnQgdXNlci5cbiAgICAgKiBAcGFyYW0gdHJhaXRzIEEgZGljdGlvbmFyeSBvZiB0cmFpdHMgZm9yIHRoZSBncm91cC5cbiAgICAgKlxuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgcHVibGljIGdyb3VwKGdyb3VwSWQ6IHN0cmluZywgdHJhaXRzPzogYW55KTogUHJvbWlzZTxTZWdtZW50U2VydmljZT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3cuYW5hbHl0aWNzLmdyb3VwKGdyb3VwSWQsIHRyYWl0cywgXyA9PiByZXNvbHZlKHRoaXMpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhlIGFsaWFzIG1ldGhvZCBjb21iaW5lcyB0d28gcHJldmlvdXNseSB1bmFzc29jaWF0ZWQgdXNlciBpZGVudGl0aWVzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHVzZXJJZCBUaGUgbmV3IHVzZXIgSUQgeW91IHdhbnQgdG8gYXNzb2NpYXRlIHdpdGggdGhlIHVzZXIuXG4gICAgICogQHBhcmFtIHByZXZpb3VzSWQgVGhlIHByZXZpb3VzIElEIHRoYXQgdGhlIHVzZXIgd2FzIHJlY29nbml6ZWQgYnkuIFRoaXMgZGVmYXVsdHMgdG8gdGhlIGN1cnJlbnRseSBpZGVudGlmaWVkIHVzZXLigJlzIElELlxuICAgICAqIEBwYXJhbSBvcHRpb25zIEEgZGljdGlvbmFyeSBvZiBvcHRpb25zLlxuICAgICAqXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBwdWJsaWMgYWxpYXModXNlcklkOiBzdHJpbmcsIHByZXZpb3VzSWQ/OiBzdHJpbmcsIG9wdGlvbnM/OiBhbnkpOiBQcm9taXNlPFNlZ21lbnRTZXJ2aWNlPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fdy5hbmFseXRpY3MuYWxpYXModXNlcklkLCBwcmV2aW91c0lkLCBvcHRpb25zLCBfID0+IHJlc29sdmUodGhpcykpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgcmVhZHkgbWV0aG9kIGFsbG93cyB5b3UgZXhlY3V0ZSBhIHByb21pc2UgdGhhdCB3aWxsIGJlIGNhbGxlZCBhcyBzb29uIGFzIGFsbCBvZiB5b3VyIGVuYWJsZWQgZGVzdGluYXRpb25zIGhhdmUgbG9hZGVkXG4gICAgICogYW5kIGFuYWx5dGljcy5qcyBoYXMgY29tcGxldGVkIGluaXRpYWxpemF0aW9uLlxuICAgICAqXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZHkoKTogUHJvbWlzZTxTZWdtZW50U2VydmljZT4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3cuYW5hbHl0aWNzLnJlYWR5KF8gPT4gcmVzb2x2ZSh0aGlzKSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybiBpbmZvcm1hdGlvbnMgYWJvdXQgdGhlIGN1cnJlbnRseSBpZGVudGlmaWVkIHVzZXJcbiAgICAgKlxuICAgICAqIEByZXR1cm5zIEluZm9ybWF0aW9ucyBhYm91dCB0aGUgY3VycmVudGx5IGlkZW50aWZpZWQgdXNlclxuICAgICAqL1xuICAgIHB1YmxpYyB1c2VyKCk6IGFueSB7XG4gICAgICAgIHJldHVybiB0aGlzLl93LmFuYWx5dGljcy51c2VyKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIGlkZW50aWZpZXIgYWJvdXQgdGhlIGN1cnJlbnRseSBpZGVudGlmaWVkIHVzZXJcbiAgICAgKlxuICAgICAqIEByZXR1cm5zIElkZW50aWZpZXIgYWJvdXQgdGhlIGN1cnJlbnRseSBpZGVudGlmaWVkIHVzZXJcbiAgICAgKi9cbiAgICBwdWJsaWMgaWQoKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLl93LmFuYWx5dGljcy5pZCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE92ZXJyaWRlIHRoZSBkZWZhdWx0IEFub255bW91cyBJRFxuICAgICAqXG4gICAgICogQHBhcmFtIGFub255bW91c0lkIE5ldyBhbm9ueW1vdXMgSURcbiAgICAgKi9cbiAgICBwdWJsaWMgc2V0QW5vbnltb3VzSWQoYW5vbnltb3VzSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLl93LmFuYWx5dGljcy5zZXRBbm9ueW1vdXNJZChhbm9ueW1vdXNJZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIHRyYWl0cyBhYm91dCB0aGUgY3VycmVudGx5IGlkZW50aWZpZWQgdXNlclxuICAgICAqXG4gICAgICogQHJldHVybnMgVHJhaXRzIGFib3V0IHRoZSBjdXJyZW50bHkgaWRlbnRpZmllZCB1c2VyXG4gICAgICovXG4gICAgcHVibGljIHRyYWl0cygpOiBhbnkge1xuICAgICAgICByZXR1cm4gdGhpcy5fdy5hbmFseXRpY3MudXNlcigpLnRyYWl0cygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlc2V0IHRoZSBpZCwgaW5jbHVkaW5nIGFub255bW91c0lkLCBhbmQgY2xlYXIgdHJhaXRzIGZvciB0aGUgY3VycmVudGx5IGlkZW50aWZpZWQgdXNlciBhbmQgZ3JvdXAuXG4gICAgICovXG4gICAgcHVibGljIHJlc2V0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLl93LmFuYWx5dGljcy5yZXNldCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFR1cm4gb24vb2ZmIGRlYnVnIG1vZGUsIGxvZ2dpbmcgaGVscGZ1bCBtZXNzYWdlcyB0byB0aGUgY29uc29sZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBlbmFibGVkIEVuYWJsZSBvciBub3QgdGhlIGRlYnVnIG1vZGVcbiAgICAgKi9cbiAgICBwdWJsaWMgZGVidWcoZW5hYmxlZD86IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fdy5hbmFseXRpY3MuZGVidWcoZW5hYmxlZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0IGxpc3RlbmVycyBmb3IgdGhlc2UgZXZlbnRzIGFuZCBydW4geW91ciBvd24gY3VzdG9tIGNvZGUuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gbWV0aG9kIE5hbWUgb2YgdGhlIG1ldGhvZCB0byBsaXN0ZW4gZm9yXG4gICAgICogQHBhcmFtIGNhbGxiYWNrIEEgZnVuY3Rpb24gdG8gZXhlY3V0ZSBhZnRlciBlYWNoIHRoZSBlbWl0dGVkIG1ldGhvZFxuICAgICAqL1xuICAgIHB1YmxpYyBvbihtZXRob2Q6IHN0cmluZywgY2FsbGJhY2s6IChldmVudD86IHN0cmluZywgcHJvcGVydGllcz86IGFueSwgb3B0aW9ucz86IGFueSkgPT4gYW55KTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3cuYW5hbHl0aWNzLm9uKG1ldGhvZCwgY2FsbGJhY2spO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEF0dGFjaGVzIHRoZSBgdHJhY2tgIGNhbGwgYXMgYSBoYW5kbGVyIHRvIGEgbGlua1xuICAgICAqXG4gICAgICogQHBhcmFtIGVsZW1lbnRzIERPTSBlbGVtZW50IG9yIGFuIGFycmF5IG9mIERPTSBlbGVtZW50cyB0byBiZSBib3VuZCB3aXRoIHRyYWNrIG1ldGhvZC5cbiAgICAgKiBAcGFyYW0gZXZlbnQgVGhlIG5hbWUgb2YgdGhlIGV2ZW50LCBwYXNzZWQgdG8gdGhlIGB0cmFja2AgbWV0aG9kIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgc3RyaW5nIHRvIGJlIHVzZWRcbiAgICAgKiAgICAgICAgICAgICAgYXMgdGhlIG5hbWUgb2YgdGhlIHRyYWNrIGV2ZW50LlxuICAgICAqIEBwYXJhbSBwcm9wZXJ0aWVzIEEgZGljdGlvbmFyeSBvZiBwcm9wZXJ0aWVzIHRvIHBhc3Mgd2l0aCB0aGUgYHRyYWNrYCBtZXRob2QuXG4gICAgICovXG4gICAgcHVibGljIHRyYWNrTGluayhlbGVtZW50czogSFRNTEVsZW1lbnQgfCBIVE1MRWxlbWVudFtdLCBldmVudDogc3RyaW5nIHwgRnVuY3Rpb24sIHByb3BlcnRpZXM/OiBhbnkgfCBGdW5jdGlvbik6IHZvaWQge1xuICAgICAgICB0aGlzLl93LmFuYWx5dGljcy50cmFja0xpbmsoZWxlbWVudHMsIGV2ZW50LCBwcm9wZXJ0aWVzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBCaW5kcyBhIGB0cmFja2AgY2FsbCB0byBhIGZvcm0gc3VibWlzc2lvbi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBmb3JtcyBUaGUgZm9ybSBlbGVtZW50IHRvIHRyYWNrIG9yIGFuIGFycmF5IG9mIGZvcm1cbiAgICAgKiBAcGFyYW0gZXZlbnQgVGhlIG5hbWUgb2YgdGhlIGV2ZW50LCBwYXNzZWQgdG8gdGhlIGB0cmFja2AgbWV0aG9kLlxuICAgICAqIEBwYXJhbSBwcm9wZXJ0aWVzIEEgZGljdGlvbmFyeSBvZiBwcm9wZXJ0aWVzIHRvIHBhc3Mgd2l0aCB0aGUgYHRyYWNrYCBtZXRob2QuXG4gICAgICovXG4gICAgcHVibGljIHRyYWNrRm9ybShmb3JtczogSFRNTEVsZW1lbnQgfCBIVE1MRWxlbWVudFtdLCBldmVudDogc3RyaW5nIHwgRnVuY3Rpb24sIHByb3BlcnRpZXM/OiBhbnkgfCBGdW5jdGlvbik6IHZvaWQge1xuICAgICAgICB0aGlzLl93LmFuYWx5dGljcy50cmFja0Zvcm0oZm9ybXMsIGV2ZW50LCBwcm9wZXJ0aWVzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXQgdGhlIGxlbmd0aCAoaW4gbWlsbGlzZWNvbmRzKSBvZiB0aGUgY2FsbGJhY2tzIGFuZCBoZWxwZXIgZnVuY3Rpb25zXG4gICAgICpcbiAgICAgKiBAcGFyYW0gdGltZW91dCBOdW1iZXIgb2YgbWlsbGlzZWNvbmRzXG4gICAgICovXG4gICAgcHVibGljIHRpbWVvdXQodGltZW91dDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3cuYW5hbHl0aWNzLnRpbWVvdXQodGltZW91dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgc291cmNlIG1pZGRsZXdhcmUgY2FsbGVkIG9uIGV2ZW50c1xuICAgICAqXG4gICAgICogQHBhcmFtIG1pZGRsZXdhcmUgQ3VzdG9tIGZ1bmN0aW9uXG4gICAgICovXG4gICAgcHVibGljIGFkZFNvdXJjZU1pZGRsZXdhcmUobWlkZGxld2FyZTogU2VnbWVudE1pZGRsZXdhcmUpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fdy5hbmFseXRpY3MuYWRkU291cmNlTWlkZGxld2FyZShtaWRkbGV3YXJlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYSBkZXN0aW5hdGlvbiBtaWRkbGV3YXJlIGNhbGxlZCBvbiBldmVudHNcbiAgICAgKlxuICAgICAqIEBwYXJhbSBpbnRlZ3JhdGlvbiBJbnRlZ3JhdGlvbiBuYW1lXG4gICAgICogQHBhcmFtIG1pZGRsZXdhcmVzIEN1c3RvbSBmdW5jdGlvbnNcbiAgICAgKi9cbiAgICBwdWJsaWMgYWRkRGVzdGluYXRpb25NaWRkbGV3YXJlKGludGVncmF0aW9uOiBzdHJpbmcsIG1pZGRsZXdhcmVzOiBTZWdtZW50TWlkZGxld2FyZVtdKTogdm9pZCB7XG4gICAgICAgIHRoaXMuX3cuYW5hbHl0aWNzLmFkZERlc3RpbmF0aW9uTWlkZGxld2FyZShpbnRlZ3JhdGlvbiwgbWlkZGxld2FyZXMpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcGx1Z2lucygpOiB7IFtwbHVnaW5OYW1lOiBzdHJpbmddOiBTZWdtZW50UGx1Z2luIH0ge1xuICAgICAgICByZXR1cm4gdGhpcy5fdy5hbmFseXRpY3MucGx1Z2lucztcbiAgICB9XG59XG4iXX0=